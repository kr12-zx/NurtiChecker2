# План Улучшения Мультиязычной Поддержки Аллергенов

## Проблема

Текущая система имеет ограничения при обработке продуктов с этикетками на языках, отличных от языка интерфейса пользователя и языка, используемого в основной базе аллергенов (сейчас это смесь английского и русского):

1.  **Определение Безопасности (`safeToConsume`):**
    *   LLM 2 в n8n получает текст ингредиентов на языке этикетки и пытается сопоставить его со справочным списком аллергенов (который сейчас на англ/рус). Успех сопоставления зависит от мультиязычных способностей LLM 2 и полноты справочника. Если LLM 2 не находит правильные ID, статус `safeToConsume` будет неверным.

2.  **Подсветка Ингредиентов в Списке (Приложение):**
    *   Функция `parseResponseData` в приложении сравнивает имена ингредиентов (на языке этикетки, полученные от LLM 1) с локальной базой аллергенов пользователя (англ/рус имена и синонимы).
    *   Из-за несовпадения языков, совпадения по имени не произойдет, и ингредиенты **не будут помечены** как аллергены (`isAllergen: false`) на экране, даже если `safeToConsume` было определено как `false`.

## Предлагаемое Решение (Перенос Логики в n8n)

Основная идея - сделать n8n полностью ответственным за сопоставление конкретного слова в ингредиентах с найденным ID аллергена.

**Шаги:**

1.  **Изменить Ноду `Process LLM Results` в n8n:**
    *   **Входные данные:** Получает структурированный список `ingredients` от LLM 1 (с именами на языке этикетки) и список `foundSubstanceIds` от LLM 2.
    *   **Новая Логика:**
        *   Итерировать по каждому объекту `ingredient` в массиве `ingredients`.
        *   Для каждого `ingredient`, определить, какому ID из `foundSubstanceIds` он соответствует. Это может потребовать:
            *   Дополнительного вызова LLM (передать имя ингредиента и список `foundSubstanceIds` с их стандартными именами/синонимами, спросить, соответствует ли имя какому-либо ID).
            *   Или, если LLM 2 была модифицирована, чтобы возвращать не только ID, но и *слово*, которое вызвало срабатывание, можно использовать это слово для сопоставления с `ingredient.name`.
        *   Если соответствие найдено, добавить поле `allergenId: 'found_id'` к объекту `ingredient`.
    *   **Выходные данные:** Отправлять в приложение JSON, где в массиве `ingredients` у соответствующих объектов будет присутствовать поле `allergenId`.

2.  **Изменить Функцию `parseResponseData` в Приложении (`utils/services/allergenAnalysisService.ts`):**
    *   **Убрать текущий поиск `potentialAllergenMatch`:** Удалить блок кода, который использует `userAllergens.find(...)` для сопоставления по имени.
    *   **Упростить определение `isAllergen`:** Получать флаг напрямую из данных, пришедших от n8n:
      ```typescript
      const allergenId = ing.allergenId || undefined;
      const isAllergen = !!allergenId;
      ```
    *   Параметр `userAllergens` больше не нужен для этой части логики внутри `map` (но может быть нужен для других целей, если они есть).

**Преимущества Решения:**

*   **Четкое разделение ответственности:** n8n отвечает за всю логику анализа и сопоставления, приложение - за отображение готового результата.
*   **Надежная Мультиязычность:** Подсветка ингредиентов будет работать независимо от языка этикетки и языка интерфейса, так как приложение полагается на `allergenId`, добавленное n8n.
*   **Упрощение Кода Приложения:** Логика в `parseResponseData` становится значительно проще.

**Потенциальные Сложности:**

*   Реализация логики сопоставления имени ингредиента с ID в `Process LLM Results` может потребовать дополнительного вызова LLM, что увеличит время ответа и стоимость.
*   Нужно тщательно протестировать точность сопоставления, выполняемого в n8n. 