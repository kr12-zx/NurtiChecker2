# План создания Workflow для персонализированных рекомендаций

## Цель проекта
Создать workflow в N8N, который будет обрабатывать запросы на персонализированные рекомендации от мобильного приложения и возвращать детальные рекомендации по питанию и витаминам.

## Структура данных

### Таблицы базы данных:
1. **webhook_events** - события пользователей с данными профиля
   - Поля: user_id, event_type, payload (JSON с данными onboarding), email_id
2. **profiles** - базовая информация о пользователях  
   - Поля: mailid, locale, timezone, timezone_offset, country
3. **meals_added** - история питания пользователей
   - Поля: kcal, prot, fat, carb, sugar, vitamins, minerals, eaten_at, mailid

## Этапы реализации

### 1. Получение и извлечение данных
- [ ] Принять webhook запрос от приложения с user_id/email_id
- [ ] Извлечь из `webhook_events` данные профиля (событие `onboarding_completed`):
  - birthday (для расчета возраста)
  - gender (пол)
  - height, currentWeight, goalWeight (физические параметры)
  - primaryGoal, weightLossRate (цели)
  - activityLevel (уровень активности)
  - dietPreference, nutritionFocus (пищевые предпочтения)
  - confidenceLevel, challenges, mainObstacle (психологический профиль)
  - stressResponse, adaptability, challengesView (поведенческие особенности)
- [ ] Получить из `profiles` дополнительную информацию:
  - locale (язык интерфейса)
  - timezone, timezone_offset (часовой пояс)
  - country (страна)
- [ ] Извлечь из `meals_added` данные о питании за последние 7 дней:
  - Суммарные калории, белки, жиры, углеводы, сахар
  - Витамины и минералы из съеденных продуктов
  - Количество дней с записями о питании
  - Средние значения по дням

### 2. Обработка и структурирование данных
- [ ] Рассчитать возраст пользователя из birthday
- [ ] Агрегировать недельную статистику питания:
  - Среднее потребление калорий в день
  - Среднее потребление макронутриентов
  - Анализ витаминов и минералов
  - Количество активных дней питания
- [ ] Сформировать полный профиль пользователя в структурированном формате для AI

### 3. AI-анализ и генерация рекомендаций
- [ ] Создать детальный промпт для AI-агента, включающий:
  - Анализ соответствия текущего питания целям
  - Выявление дефицитов/избытков нутриентов
  - Учет психологических особенностей и препятствий
  - Персонализацию под конкретные цели пользователя
- [ ] Передать структурированные данные AI-агенту
- [ ] Получить от AI рекомендации:
  - **Питание на 1-2 дня**: конкретные блюда/продукты
  - **Витамины и минералы**: анализ и рекомендации по корректировке
  - Учет локали пользователя для языка ответа

### 4. Форматирование и возврат ответа
- [ ] Структурировать ответ в JSON формате для приложения
- [ ] Обеспечить соответствие формату, ожидаемому мобильным приложением
- [ ] Вернуть рекомендации через webhook response
- [ ] Обработать возможные ошибки и fallback сценарии

## Ключевые требования

### Персонализация:
- Учет психологического профиля (эмоциональное переедание, уровень уверенности)
- Персонализация под конкретные цели (похудение, набор веса, поддержание)
- Анализ реального питания за неделю, а не теоретических норм

### Технические требования:
- Многоязычность (ru/en/es) на основе locale
- Обработка часовых поясов для корректного анализа данных
- Рекомендации по витаминам на основе фактического потребления
- Устойчивость к отсутствующим данным

### Формат выходных данных:
- JSON структура совместимая с мобильным приложением
- Рекомендации на 1-2 дня вперед
- Детальный анализ витаминов и минералов
- Понятные и actionable советы для пользователя

## Контрольные точки
1. ✅ Успешное извлечение данных из всех трех таблиц
2. ✅ Корректная агрегация недельной статистики питания
3. ✅ Правильное структурирование данных для AI
4. ✅ Получение релевантных рекомендаций от AI
5. ✅ Корректное форматирование ответа для приложения
6. ✅ Тестирование на реальных данных пользователей

## Примечания
- Этот план служит ориентиром для последовательной реализации
- При отклонении от плана необходимо сверяться с этим документом
- Каждый этап должен быть протестирован перед переходом к следующему

---

## ТЕКУЩИЙ СТАТУС РЕАЛИЗАЦИИ

### Выполнено:
- ✅ Создан базовый workflow файл `7_personalized_recommendations.json`
- ✅ Настроен webhook endpoint `/get-recommendations`
- ✅ Добавлена валидация входных данных
- ✅ Создан базовый ответ с примерными рекомендациями
- ✅ Настроена обработка ошибок

### В работе:
- ⚠️ Интеграция с базой данных для извлечения реальных данных пользователя

### Следующие шаги:
1. Добавить извлечение данных из базы (webhook_events, profiles, meals_added)
2. Интегрировать OpenAI для генерации персонализированных рекомендаций
3. Добавить логирование успешных операций
4. Протестировать с реальными данными 